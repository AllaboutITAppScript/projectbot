<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line Bot Chat - Customer Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        .bot-message {
            background-color: #f1f5f9;
            color: #334155;
            border-radius: 18px 18px 18px 4px;
        }
        .agent-message {
            background-color: #10b981;
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        .typing-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #94a3b8;
            margin: 0 2px;
            animation: bounce 1.3s infinite ease-in-out;
        }
        .typing-indicator:nth-child(2) {
            animation-delay: 0.15s;
        }
        .typing-indicator:nth-child(3) {
            animation-delay: 0.3s;
        }
        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        .quick-reply {
            transition: all 0.2s ease;
        }
        .quick-reply:hover {
            transform: translateY(-2px);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-away { background-color: #f59e0b; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto max-w-md h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm py-4 px-6 flex items-center justify-between rounded-b-2xl">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                    <i class="fab fa-line"></i>
                </div>
                <div class="ml-3">
                    <h1 class="font-bold text-gray-800">Customer Service</h1>
                    <p class="text-xs flex items-center">
                        <span class="status-indicator status-online"></span>
                        <span id="connectionStatus" class="text-green-500">กำลังเชื่อมต่อกับบอท</span>
                    </p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="refreshBtn" class="text-gray-500 hover:text-blue-500 p-2" title="รีเฟรชการสนทนา">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button id="menuBtn" class="text-gray-500 hover:text-gray-700 p-2">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </header>

        <!-- Connection Info Banner -->
        <div id="connectionBanner" class="bg-blue-50 border border-blue-200 mx-4 mt-2 p-3 rounded-lg flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                <span class="text-sm text-blue-700">กำลังดึงข้อมูลการสนทนาจาก Line Bot</span>
            </div>
            <button id="closeBanner" class="text-blue-500 hover:text-blue-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Chat Container -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="flex justify-center items-center py-8">
                <div class="text-center">
                    <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-2"></div>
                    <p class="text-gray-500 text-sm">กำลังโหลดประวัติการสนทนา...</p>
                </div>
            </div>

            <!-- Messages will be loaded here -->
        </div>

        <!-- Input Area -->
        <div class="bg-white p-4 border-t border-gray-200">
            <div class="flex items-center">
                <button id="attachBtn" class="text-gray-500 hover:text-gray-700 p-2">
                    <i class="fas fa-paperclip"></i>
                </button>
                <div class="flex-1 mx-2">
                    <input 
                        id="messageInput" 
                        type="text" 
                        placeholder="พิมพ์ข้อความที่นี่..." 
                        class="w-full bg-gray-100 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <button id="sendBtn" class="bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-blue-600 transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <!-- Quick Reply Buttons -->
            <div id="quickReplies" class="flex flex-wrap gap-2 justify-start mt-3">
                <button class="quick-reply bg-white border border-blue-200 rounded-full px-4 py-2 text-sm text-blue-700 hover:bg-blue-50">
                    สอบถามสินค้า
                </button>
                <button class="quick-reply bg-white border border-blue-200 rounded-full px-4 py-2 text-sm text-blue-700 hover:bg-blue-50">
                    ติดตามออร์เดอร์
                </button>
                <button class="quick-reply bg-white border border-blue-200 rounded-full px-4 py-2 text-sm text-blue-700 hover:bg-blue-50">
                    ปัญหาการใช้งาน
                </button>
            </div>
        </div>
    </div>

    <!-- Menu Modal -->
    <div id="menuModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 w-80 max-w-full mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">เมนู</h2>
            <div class="space-y-3">
                <button id="historyBtn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 flex items-center">
                    <i class="fas fa-history text-gray-500 mr-3"></i>
                    <span>ประวัติการสนทนา</span>
                </button>
                <button id="settingsBtn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 flex items-center">
                    <i class="fas fa-cog text-gray-500 mr-3"></i>
                    <span>การตั้งค่าบอท</span>
                </button>
                <button id="helpBtn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 flex items-center">
                    <i class="fas fa-question-circle text-gray-500 mr-3"></i>
                    <span>ความช่วยเหลือ</span>
                </button>
                <button id="closeMenu" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 flex items-center text-red-500">
                    <i class="fas fa-times mr-3"></i>
                    <span>ปิด</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl w-11/12 max-w-md mx-4 max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">การตั้งค่าบอท</h2>
                <button id="closeSettings" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Line Bot API Endpoint</label>
                        <input type="text" id="botEndpoint" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://your-bot-api.com/webhook">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Channel Access Token</label>
                        <input type="password" id="channelToken" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ใส่ Channel Access Token">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="autoRefresh" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="autoRefresh" class="ml-2 text-sm text-gray-700">รีเฟรชการสนทนาอัตโนมัติ</label>
                    </div>
                    <div>
                        <button id="testConnection" class="w-full bg-blue-500 text-white rounded-lg py-2 hover:bg-blue-600 transition-colors">
                            ทดสอบการเชื่อมต่อ
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-2">
                <button id="saveSettings" class="bg-green-500 text-white rounded-lg px-4 py-2 hover:bg-green-600 transition-colors">
                    บันทึกการตั้งค่า
                </button>
            </div>
        </div>
    </div>

    <script>
        // LIFF Initialization
        liff.init({
            liffId: '1656079273-rkZlk8kp' // ใส่ LIFF ID ของคุณที่นี่
        })
        .then(() => {
            console.log('LIFF initialized');
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                initializeChat();
            }
        })
        .catch((err) => {
            console.error('LIFF initialization failed', err);
            showError('ไม่สามารถเชื่อมต่อกับ Line ได้');
        });

        // DOM Elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const menuBtn = document.getElementById('menuBtn');
        const menuModal = document.getElementById('menuModal');
        const closeMenu = document.getElementById('closeMenu');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const saveSettings = document.getElementById('saveSettings');
        const testConnection = document.getElementById('testConnection');
        const connectionBanner = document.getElementById('connectionBanner');
        const closeBanner = document.getElementById('closeBanner');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const quickReplies = document.querySelectorAll('.quick-reply');
        const connectionStatus = document.getElementById('connectionStatus');

        // ตัวแปรเก็บการตั้งค่า
        let botSettings = {
            endpoint: localStorage.getItem('botEndpoint') || '',
            channelToken: localStorage.getItem('channelToken') || '',
            autoRefresh: localStorage.getItem('autoRefresh') === 'true'
        };

        // ตัวแปรเก็บข้อมูลผู้ใช้
        let userProfile = null;

        // Functions
        function initializeChat() {
            // โหลดการตั้งค่า
            loadSettings();
            
            // ดึงข้อมูลโปรไฟล์ผู้ใช้
            getUserProfile();
            
            // โหลดประวัติการสนทนา
            loadChatHistory();
            
            // ตั้งค่า Auto Refresh ถ้าเปิดใช้งาน
            if (botSettings.autoRefresh) {
                setInterval(loadChatHistory, 30000); // รีเฟรชทุก 30 วินาที
            }
        }

        function loadSettings() {
            document.getElementById('botEndpoint').value = botSettings.endpoint;
            document.getElementById('channelToken').value = botSettings.channelToken;
            document.getElementById('autoRefresh').checked = botSettings.autoRefresh;
        }

        function saveBotSettings() {
            botSettings.endpoint = document.getElementById('botEndpoint').value;
            botSettings.channelToken = document.getElementById('channelToken').value;
            botSettings.autoRefresh = document.getElementById('autoRefresh').checked;
            
            localStorage.setItem('botEndpoint', botSettings.endpoint);
            localStorage.setItem('channelToken', botSettings.channelToken);
            localStorage.setItem('autoRefresh', botSettings.autoRefresh);
            
            alert('บันทึกการตั้งค่าเรียบร้อยแล้ว');
            settingsModal.classList.add('hidden');
        }

        async function testBotConnection() {
            if (!botSettings.endpoint || !botSettings.channelToken) {
                alert('กรุณากรอก API Endpoint และ Channel Token');
                return;
            }
            
            try {
                const response = await fetch(`${botSettings.endpoint}/test`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${botSettings.channelToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('การเชื่อมต่อกับบอทสำเร็จ!');
                } else {
                    alert('ไม่สามารถเชื่อมต่อกับบอทได้');
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                alert('การทดสอบการเชื่อมต่อล้มเหลว: ' + error.message);
            }
        }

        function getUserProfile() {
            liff.getProfile()
            .then(profile => {
                userProfile = profile;
                console.log('User profile loaded:', profile);
            })
            .catch((err) => {
                console.error('Error getting profile:', err);
            });
        }

        async function loadChatHistory() {
            if (!botSettings.endpoint || !botSettings.channelToken) {
                showError('กรุณาตั้งค่า API Endpoint และ Channel Token ก่อน');
                return;
            }
            
            try {
                loadingIndicator.classList.remove('hidden');
                connectionStatus.textContent = 'กำลังโหลดการสนทนา...';
                connectionStatus.className = 'text-yellow-500';
                
                // ส่ง request ไปยัง Line Bot เพื่อดึงประวัติการสนทนา
                const response = await fetch(`${botSettings.endpoint}/chat/history`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${botSettings.channelToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userProfile?.userId,
                        limit: 50 // จำนวนข้อความที่ต้องการดึง
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayChatHistory(data.messages);
                
                connectionStatus.textContent = 'เชื่อมต่อกับบอทแล้ว';
                connectionStatus.className = 'text-green-500';
                
            } catch (error) {
                console.error('Failed to load chat history:', error);
                showError('ไม่สามารถโหลดประวัติการสนทนาได้: ' + error.message);
                
                connectionStatus.textContent = 'การเชื่อมต่อมีปัญหา';
                connectionStatus.className = 'text-red-500';
                
                // แสดงข้อมูลตัวอย่างหากไม่สามารถเชื่อมต่อได้
                displaySampleChatHistory();
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function displayChatHistory(messages) {
            chatContainer.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center py-8 text-gray-500';
                emptyMessage.innerHTML = `
                    <i class="fas fa-comments text-4xl mb-3"></i>
                    <p>ยังไม่มีการสนทนา</p>
                    <p class="text-sm mt-2">เริ่มการสนทนาโดยการส่งข้อความแรก</p>
                `;
                chatContainer.appendChild(emptyMessage);
                return;
            }
            
            // เรียงข้อความตามเวลา (จากเก่าสุดไปล่าสุด)
            messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            messages.forEach(message => {
                addMessageToChat(message.text, message.sender, new Date(message.timestamp));
            });
            
            // Scroll ไปที่ล่างสุด
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displaySampleChatHistory() {
            const sampleMessages = [
                {
                    text: "สวัสดีค่ะ! มีอะไรให้ช่วยเหลือไหมคะ?",
                    sender: "bot",
                    timestamp: new Date(Date.now() - 300000).toISOString()
                },
                {
                    text: "สอบถามราคาสินค้าครับ",
                    sender: "user", 
                    timestamp: new Date(Date.now() - 240000).toISOString()
                },
                {
                    text: "ขอทราบรายละเอียดสินค้าที่สนใจด้วยค่ะ",
                    sender: "bot",
                    timestamp: new Date(Date.now() - 180000).toISOString()
                }
            ];
            
            displayChatHistory(sampleMessages);
            
            const warningMessage = document.createElement('div');
            warningMessage.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-yellow-800 text-sm mt-4';
            warningMessage.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>กำลังแสดงข้อมูลตัวอย่าง เนื่องจากไม่สามารถเชื่อมต่อกับบอทได้</span>
                </div>
            `;
            chatContainer.appendChild(warningMessage);
        }

        function addMessageToChat(text, sender, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
            
            const bubble = document.createElement('div');
            let bubbleClass = 'message-bubble p-4 shadow-sm ';
            
            if (sender === 'user') {
                bubbleClass += 'user-message';
            } else if (sender === 'agent') {
                bubbleClass += 'agent-message';
            } else {
                bubbleClass += 'bot-message';
            }
            
            bubble.className = bubbleClass;
            
            const messageText = document.createElement('div');
            messageText.textContent = text;
            
            const timeText = document.createElement('div');
            timeText.className = 'text-xs mt-1 opacity-70';
            timeText.textContent = formatTime(timestamp);
            
            bubble.appendChild(messageText);
            bubble.appendChild(timeText);
            messageDiv.appendChild(bubble);
            
            chatContainer.appendChild(messageDiv);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        async function sendMessageToBot(messageText) {
            if (!botSettings.endpoint || !botSettings.channelToken) {
                showError('กรุณาตั้งค่า API Endpoint และ Channel Token ก่อน');
                return;
            }
            
            try {
                // แสดงข้อความของผู้ใช้ในแชททันที
                addMessageToChat(messageText, 'user', new Date());
                
                // ส่งข้อความไปยัง Line Bot
                const response = await fetch(`${botSettings.endpoint}/message`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${botSettings.channelToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userProfile?.userId,
                        message: messageText,
                        replyToken: generateReplyToken()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // แสดงข้อความตอบกลับจากบอท
                if (data.reply) {
                    addMessageToChat(data.reply, 'bot', new Date());
                }
                
            } catch (error) {
                console.error('Failed to send message:', error);
                showError('ไม่สามารถส่งข้อความได้: ' + error.message);
                
                // แสดงข้อความตอบกลับตัวอย่าง
                setTimeout(() => {
                    const sampleReplies = [
                        "ขอบคุณสำหรับข้อความค่ะ ฉันจะตอบกลับคุณเร็วๆ นี้",
                        "ได้รับข้อความของคุณแล้ว ขอเวลาตรวจสอบข้อมูลหน่อยนะคะ",
                        "ขออภัยในความไม่สะดวก ขณะนี้มีข้อขัดข้องทางเทคนิค"
                    ];
                    const randomReply = sampleReplies[Math.floor(Math.random() * sampleReplies.length)];
                    addMessageToChat(randomReply, 'bot', new Date());
                }, 1000);
            }
        }

        function generateReplyToken() {
            return 'token_' + Math.random().toString(36).substr(2, 9);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-3 text-red-800 text-sm mb-4';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            chatContainer.appendChild(errorDiv);
        }

        // Event Listeners
        sendBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                sendMessageToBot(message);
                messageInput.value = '';
            }
        });
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const message = messageInput.value.trim();
                if (message) {
                    sendMessageToBot(message);
                    messageInput.value = '';
                }
            }
        });

        refreshBtn.addEventListener('click', loadChatHistory);

        menuBtn.addEventListener('click', () => {
            menuModal.classList.remove('hidden');
        });

        closeMenu.addEventListener('click', () => {
            menuModal.classList.add('hidden');
        });

        settingsBtn.addEventListener('click', () => {
            menuModal.classList.add('hidden');
            settingsModal.classList.remove('hidden');
        });

        closeSettings.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        saveSettings.addEventListener('click', saveBotSettings);

        testConnection.addEventListener('click', testBotConnection);

        closeBanner.addEventListener('click', () => {
            connectionBanner.classList.add('hidden');
        });

        // เพิ่ม event listener ให้กับ quick replies
        quickReplies.forEach(button => {
            button.addEventListener('click', () => {
                const message = button.textContent;
                sendMessageToBot(message);
            });
        });

        // โหลดการสนทนาเมื่อหน้าเว็บโหลดเสร็จ
        document.addEventListener('DOMContentLoaded', initializeChat);
    </script>
</body>
</html>
